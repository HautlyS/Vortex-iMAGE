name: iOS Build (Fastlane/Match)

# Advanced iOS build workflow using Fastlane Match for certificate management
# Use this for production builds with team certificate sharing
# Requires: Match repository setup with certificates

on:
  workflow_dispatch:
    inputs:
      export_method:
        description: 'Export method'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - ad-hoc
          - app-store
      upload_to_testflight:
        description: 'Upload to TestFlight (app-store only)'
        required: false
        default: false
        type: boolean
      increment_build:
        description: 'Auto-increment build number'
        required: false
        default: true
        type: boolean

concurrency:
  group: ios-fastlane-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  BUNDLE_ID: com.vortex.image
  APP_NAME: iMAGE

jobs:
  # Build Tauri iOS project
  prepare:
    runs-on: macos-14
    timeout-minutes: 30
    outputs:
      xcodeproj: ${{ steps.info.outputs.xcodeproj }}
      scheme: ${{ steps.info.outputs.scheme }}
      workspace: ${{ steps.info.outputs.workspace }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          sudo xcode-select -s "$XCODE_PATH/Contents/Developer"
          xcodebuild -version

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Cache pnpm
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,x86_64-apple-ios,aarch64-apple-ios-sim

      - name: Cache Rust
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        run: pnpm run build

      - name: Initialize iOS project
        run: pnpm tauri ios init || true

      - name: Build Tauri iOS (prepare Xcode project)
        run: |
          pnpm tauri ios build --debug -- \
            -destination "generic/platform=iOS Simulator" \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO || true

      - name: Get project info
        id: info
        run: |
          XCODEPROJ=$(find src-tauri/gen/apple -name "*.xcodeproj" -type d | head -1)
          WORKSPACE=$(find src-tauri/gen/apple -name "*.xcworkspace" -type d | head -1)
          
          echo "xcodeproj=$XCODEPROJ" >> $GITHUB_OUTPUT
          echo "workspace=$WORKSPACE" >> $GITHUB_OUTPUT
          
          # Get scheme
          if [[ -n "$WORKSPACE" ]]; then
            SCHEME=$(xcodebuild -workspace "$WORKSPACE" -list 2>/dev/null | \
              awk '/Schemes:/{found=1; next} found && /^[[:space:]]+[^[:space:]]/{print $1; exit}')
          elif [[ -n "$XCODEPROJ" ]]; then
            SCHEME=$(xcodebuild -project "$XCODEPROJ" -list 2>/dev/null | \
              awk '/Schemes:/{found=1; next} found && /^[[:space:]]+[^[:space:]]/{print $1; exit}')
          fi
          
          echo "scheme=${SCHEME:-${APP_NAME}_iOS}" >> $GITHUB_OUTPUT

      - name: Upload iOS project
        uses: actions/upload-artifact@v4
        with:
          name: ios-project
          path: |
            src-tauri/gen/apple/
            dist/
          retention-days: 1

  # Build with sparkfabrik action (if Match is configured)
  build-sparkfabrik:
    needs: prepare
    runs-on: macos-14
    timeout-minutes: 45
    if: ${{ vars.USE_SPARKFABRIK == 'true' }}
    continue-on-error: true
    outputs:
      success: ${{ steps.result.outputs.success }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download iOS project
        uses: actions/download-artifact@v4
        with:
          name: ios-project

      - name: Restore project structure
        run: |
          # Ensure directories exist
          mkdir -p src-tauri/gen/apple dist
          
          # Move downloaded files if needed
          if [[ -d "apple" ]]; then
            mv apple/* src-tauri/gen/apple/ 2>/dev/null || true
          fi

      - name: Check Match configuration
        id: check-match
        run: |
          if [[ -z "${{ secrets.MATCH_GIT_URL }}" ]]; then
            echo "::warning::MATCH_GIT_URL not configured, skipping sparkfabrik build"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Build with sparkfabrik/ios-build-action
        if: steps.check-match.outputs.skip != 'true'
        id: sparkfabrik
        uses: sparkfabrik/ios-build-action@v2.3.2
        with:
          project-path: ${{ needs.prepare.outputs.xcodeproj }}
          workspace-path: ${{ needs.prepare.outputs.workspace }}
          scheme: ${{ needs.prepare.outputs.scheme }}
          export-method: ${{ github.event.inputs.export_method }}
          configuration: Release
          team-id: ${{ secrets.APPLE_TEAM_ID }}
          team-name: ${{ secrets.APPLE_TEAM_NAME }}
          match-git-url: ${{ secrets.MATCH_GIT_URL }}
          match-git-basic-authorization: ${{ secrets.MATCH_GIT_BASIC_AUTH }}
          match-password: ${{ secrets.MATCH_PASSWORD }}
          match-build-type: ${{ github.event.inputs.export_method }}
          ios-app-id: ${{ env.BUNDLE_ID }}
          upload-to-testflight: ${{ github.event.inputs.upload_to_testflight == 'true' && github.event.inputs.export_method == 'app-store' }}
          increment-build-number: ${{ github.event.inputs.increment_build }}
          apple-key-id: ${{ secrets.APPLE_API_KEY_ID }}
          apple-key-issuer-id: ${{ secrets.APPLE_API_ISSUER_ID }}
          apple-key-content: ${{ secrets.APPLE_API_KEY_CONTENT }}
        continue-on-error: true

      - name: Check result
        id: result
        run: |
          if [[ -f "output.ipa" ]]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "::notice::Sparkfabrik build succeeded"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "::warning::Sparkfabrik build did not produce IPA"
          fi

      - name: Upload IPA
        if: steps.result.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-sparkfabrik
          path: output.ipa
          retention-days: 30

  # Fallback: Custom Fastlane build
  build-fastlane:
    needs: [prepare, build-sparkfabrik]
    runs-on: macos-14
    timeout-minutes: 45
    if: |
      always() && 
      (needs.build-sparkfabrik.result == 'skipped' || 
       needs.build-sparkfabrik.outputs.success != 'true')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download iOS project
        uses: actions/download-artifact@v4
        with:
          name: ios-project

      - name: Restore project structure
        run: |
          mkdir -p src-tauri/gen dist
          [[ -d "apple" ]] && mv apple src-tauri/gen/ || true

      - name: Select Xcode
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          sudo xcode-select -s "$XCODE_PATH/Contents/Developer"

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install Fastlane
        run: |
          gem install fastlane
          fastlane --version

      - name: Create Fastfile
        run: |
          mkdir -p fastlane
          cat > fastlane/Fastfile << 'FASTFILE'
          default_platform(:ios)
          
          platform :ios do
            desc "Build iOS app"
            lane :build do |options|
              # Setup Match if configured
              if ENV['MATCH_GIT_URL'] && !ENV['MATCH_GIT_URL'].empty?
                match(
                  type: options[:export_method] || "development",
                  app_identifier: ENV['BUNDLE_ID'],
                  git_url: ENV['MATCH_GIT_URL'],
                  git_basic_authorization: ENV['MATCH_GIT_BASIC_AUTH'],
                  keychain_name: "fastlane_keychain",
                  keychain_password: ENV['KEYCHAIN_PASSWORD'] || "fastlane",
                  readonly: true
                )
              end
              
              # Build
              gym(
                project: ENV['XCODEPROJ'],
                scheme: ENV['SCHEME'],
                configuration: "Release",
                export_method: options[:export_method] || "development",
                output_directory: "./build",
                output_name: "#{ENV['APP_NAME']}.ipa",
                clean: true,
                skip_codesigning: ENV['MATCH_GIT_URL'].to_s.empty?
              )
            end
            
            desc "Upload to TestFlight"
            lane :upload do
              api_key = app_store_connect_api_key(
                key_id: ENV['APPLE_API_KEY_ID'],
                issuer_id: ENV['APPLE_API_ISSUER_ID'],
                key_content: ENV['APPLE_API_KEY_CONTENT'],
                in_house: false
              )
              
              upload_to_testflight(
                api_key: api_key,
                ipa: "./build/#{ENV['APP_NAME']}.ipa",
                skip_waiting_for_build_processing: true
              )
            end
          end
          FASTFILE

      - name: Setup keychain
        run: |
          security create-keychain -p "fastlane" fastlane_keychain
          security unlock-keychain -p "fastlane" fastlane_keychain
          security set-keychain-settings -lut 21600 fastlane_keychain
          security list-keychain -d user -s fastlane_keychain

      - name: Install certificates (manual)
        if: ${{ secrets.BUILD_CERTIFICATE_BASE64 != '' && secrets.MATCH_GIT_URL == '' }}
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
        run: |
          CERT_PATH=$RUNNER_TEMP/cert.p12
          echo "$BUILD_CERTIFICATE_BASE64" | base64 --decode > $CERT_PATH
          
          security import $CERT_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k fastlane_keychain
          security set-key-partition-list -S apple-tool:,apple: -k "fastlane" fastlane_keychain
          
          if [[ -n "$BUILD_PROVISION_PROFILE_BASE64" ]]; then
            PP_PATH=$RUNNER_TEMP/profile.mobileprovision
            echo "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode > $PP_PATH
            mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
            PROFILE_UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" /dev/stdin <<< $(security cms -D -i "$PP_PATH"))
            cp "$PP_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/${PROFILE_UUID}.mobileprovision
          fi

      - name: Build with Fastlane
        env:
          XCODEPROJ: ${{ needs.prepare.outputs.xcodeproj }}
          SCHEME: ${{ needs.prepare.outputs.scheme }}
          BUNDLE_ID: ${{ env.BUNDLE_ID }}
          APP_NAME: ${{ env.APP_NAME }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_GIT_BASIC_AUTH: ${{ secrets.MATCH_GIT_BASIC_AUTH }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          KEYCHAIN_PASSWORD: fastlane
        run: |
          fastlane build export_method:${{ github.event.inputs.export_method }}

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-fastlane
          path: ./build/*.ipa
          retention-days: 30
          if-no-files-found: warn

      - name: Upload to TestFlight
        if: ${{ github.event.inputs.upload_to_testflight == 'true' && github.event.inputs.export_method == 'app-store' }}
        env:
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          APPLE_API_KEY_CONTENT: ${{ secrets.APPLE_API_KEY_CONTENT }}
          APP_NAME: ${{ env.APP_NAME }}
        run: |
          if [[ -f "./build/${APP_NAME}.ipa" ]]; then
            fastlane upload
          else
            echo "::error::No IPA found for TestFlight upload"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          security delete-keychain fastlane_keychain 2>/dev/null || true

  # Summary job
  summary:
    needs: [prepare, build-sparkfabrik, build-fastlane]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Build Summary
        run: |
          echo "## iOS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Prepare | ${{ needs.prepare.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Sparkfabrik | ${{ needs.build-sparkfabrik.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Fastlane | ${{ needs.build-fastlane.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Export Method:** ${{ github.event.inputs.export_method }}" >> $GITHUB_STEP_SUMMARY
          echo "**TestFlight Upload:** ${{ github.event.inputs.upload_to_testflight }}" >> $GITHUB_STEP_SUMMARY
