name: iOS Sideload Build (Free Apple ID)

# Build and sign IPA using free Apple ID (like Sideloadly)
# Signs with your personal Apple ID - apps expire after 7 days
# No paid Developer account required!

on:
  push:
    branches: [main, release]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      bundle_id:
        description: 'Bundle ID (must be unique per Apple ID)'
        required: false
        default: ''
      bundle_name:
        description: 'App display name'
        required: false
        default: 'iMAGE'

concurrency:
  group: ios-sideload-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  DEFAULT_BUNDLE_ID: com.vortex.image
  APP_NAME: iMAGE

jobs:
  # Step 1: Build unsigned IPA on macOS
  build-unsigned:
    runs-on: macos-14
    timeout-minutes: 45
    outputs:
      ipa_name: ${{ steps.package.outputs.ipa_name }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          sudo xcode-select -s "$XCODE_PATH/Contents/Developer"
          xcodebuild -version

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Cache pnpm
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,x86_64-apple-ios,aarch64-apple-ios-sim

      - name: Cache Rust
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        run: pnpm run build

      - name: Initialize iOS project
        run: pnpm tauri ios init || true

      - name: Update bundle ID if specified
        if: ${{ github.event.inputs.bundle_id != '' }}
        run: |
          # Update tauri.conf.json
          sed -i '' 's/"identifier": "[^"]*"/"identifier": "${{ github.event.inputs.bundle_id }}"/' src-tauri/tauri.conf.json
          
          # Re-init iOS project with new bundle ID
          rm -rf src-tauri/gen/apple
          pnpm tauri ios init

      - name: Disable code signing in Xcode project
        run: |
          XCODEPROJ=$(find src-tauri/gen/apple -name "*.xcodeproj" -type d | head -1)
          
          if [[ -z "$XCODEPROJ" ]]; then
            echo "::error::No Xcode project found"
            exit 1
          fi
          
          PBXPROJ="$XCODEPROJ/project.pbxproj"
          
          echo "Modifying: $PBXPROJ"
          
          # Disable code signing completely
          sed -i '' 's/CODE_SIGN_IDENTITY = "[^"]*"/CODE_SIGN_IDENTITY = ""/g' "$PBXPROJ"
          sed -i '' 's/CODE_SIGN_IDENTITY = -/CODE_SIGN_IDENTITY = ""/g' "$PBXPROJ"
          sed -i '' 's/"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]" = "[^"]*"/"CODE_SIGN_IDENTITY[sdk=iphoneos*]" = ""/g' "$PBXPROJ"
          
          # Set signing to manual and disable
          sed -i '' 's/CODE_SIGNING_REQUIRED = YES/CODE_SIGNING_REQUIRED = NO/g' "$PBXPROJ"
          sed -i '' 's/CODE_SIGNING_ALLOWED = YES/CODE_SIGNING_ALLOWED = NO/g' "$PBXPROJ"
          
          # Remove development team requirement
          sed -i '' 's/DEVELOPMENT_TEAM = "[^"]*"/DEVELOPMENT_TEAM = ""/g' "$PBXPROJ"
          
          # Replace the tauri xcode-script with a no-op (it requires dev server)
          sed -i '' 's|pnpm tauri ios xcode-script|echo "Skipping tauri xcode-script in CI"|g' "$PBXPROJ"
          
          echo "Code signing disabled in project"

      - name: Build Rust library for iOS
        run: |
          cd src-tauri
          
          # Build for real iOS device (arm64)
          echo "Building Rust for aarch64-apple-ios..."
          cargo build --release --target aarch64-apple-ios
          
          # Find and display the built library
          echo "Built libraries:"
          find target/aarch64-apple-ios -name "*.a" -type f 2>/dev/null | head -5
          
          cd ..

      - name: Build iOS (unsigned)
        run: |
          # Build using xcodebuild directly with all signing disabled
          XCODEPROJ=$(find src-tauri/gen/apple -name "*.xcodeproj" -type d | head -1)
          SCHEME=$(xcodebuild -project "$XCODEPROJ" -list 2>/dev/null | awk '/Schemes:/{found=1; next} found && /^[[:space:]]+[^[:space:]]/{print $1; exit}')
          
          echo "Building project: $XCODEPROJ"
          echo "Scheme: $SCHEME"
          
          # Build with xcodebuild
          xcodebuild build \
            -project "$XCODEPROJ" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -derivedDataPath ./build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            ONLY_ACTIVE_ARCH=NO

      - name: Find and package app
        id: package
        run: |
          # Find the .app bundle in build output
          APP_PATH=$(find ./build -name "*.app" -type d 2>/dev/null | head -1)
          
          # Fallback to gen/apple if not in build dir
          if [[ -z "$APP_PATH" ]]; then
            APP_PATH=$(find src-tauri/gen/apple -name "*.app" -type d 2>/dev/null | head -1)
          fi
          
          if [[ -z "$APP_PATH" ]]; then
            echo "::error::No .app bundle found"
            echo "Searching in all locations..."
            find . -name "*.app" -type d 2>/dev/null || true
            exit 1
          fi
          
          echo "Found app: $APP_PATH"
          
          # Create Payload directory structure for IPA
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/
          
          # Create unsigned IPA
          IPA_NAME="${{ env.APP_NAME }}-unsigned.ipa"
          zip -r "$IPA_NAME" Payload
          
          echo "ipa_name=$IPA_NAME" >> $GITHUB_OUTPUT
          echo "Created: $IPA_NAME"
          ls -la "$IPA_NAME"

      - name: Upload unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-ipa
          path: ${{ steps.package.outputs.ipa_name }}
          retention-days: 7

  # Step 2: Sign IPA with free Apple ID using AltServer-Linux
  sign-with-apple-id:
    needs: build-unsigned
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Always run - will check for secrets inside the job
    
    steps:
      - name: Check for Apple ID credentials
        id: check-creds
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
        run: |
          if [[ -n "$APPLE_ID" && -n "$APPLE_ID_PASSWORD" ]]; then
            echo "has_creds=true" >> $GITHUB_OUTPUT
            echo "Apple ID credentials found"
          else
            echo "has_creds=false" >> $GITHUB_OUTPUT
            echo "::warning::No Apple ID credentials configured. Set APPLE_ID and APPLE_ID_PASSWORD secrets."
          fi

      - name: Download unsigned IPA
        if: steps.check-creds.outputs.has_creds == 'true'
        uses: actions/download-artifact@v4
        with:
          name: unsigned-ipa
          path: ./

      - name: Install dependencies
        if: steps.check-creds.outputs.has_creds == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libavahi-compat-libdnssd-dev \
            usbmuxd \
            libimobiledevice-dev \
            libplist-dev \
            libusbmuxd-dev \
            libssl-dev \
            unzip \
            zip

      - name: Download AltServer-Linux
        if: steps.check-creds.outputs.has_creds == 'true'
        run: |
          # Download pre-built AltServer-Linux
          wget -q https://github.com/NyaMisty/AltServer-Linux/releases/download/v0.0.5/AltServer-x86_64 -O AltServer
          chmod +x AltServer
          
          # Verify
          ./AltServer --version || echo "AltServer downloaded"

      - name: Sign IPA with Apple ID
        if: steps.check-creds.outputs.has_creds == 'true'
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          ANISETTE_URL: ${{ secrets.ANISETTE_URL }}
        run: |
          IPA_FILE="${{ needs.build-unsigned.outputs.ipa_name }}"
          SIGNED_IPA="${{ env.APP_NAME }}-signed.ipa"
          BUNDLE_ID="${{ github.event.inputs.bundle_id || env.DEFAULT_BUNDLE_ID }}"
          ANISETTE="${ANISETTE_URL:-https://ani.f1sh.me}"
          
          echo "Signing $IPA_FILE with Apple ID..."
          echo "Bundle ID: $BUNDLE_ID"
          echo "Anisette server: $ANISETTE"
          
          # Use AltServer to sign
          ./AltServer -u "$APPLE_ID" -p "$APPLE_ID_PASSWORD" \
            -a "$ANISETTE" \
            -b "$BUNDLE_ID" \
            -o "$SIGNED_IPA" \
            "$IPA_FILE" || {
              echo "::warning::AltServer signing failed, trying zsign ad-hoc..."
              
              # Fallback: Use zsign for ad-hoc signing
              wget -q https://github.com/zhlynn/zsign/releases/latest/download/zsign-linux-x64 -O zsign || \
              wget -q https://github.com/xtool-org/zsign/releases/latest/download/zsign-linux-x64 -O zsign
              chmod +x zsign
              
              ./zsign -a -o "$SIGNED_IPA" "$IPA_FILE"
            }
          
          if [[ -f "$SIGNED_IPA" ]]; then
            echo "Successfully created: $SIGNED_IPA"
            ls -la "$SIGNED_IPA"
          else
            echo "::error::Failed to create signed IPA"
            exit 1
          fi

      - name: Upload signed IPA
        if: steps.check-creds.outputs.has_creds == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: signed-ipa-${{ github.sha }}
          path: ${{ env.APP_NAME }}-signed.ipa
          retention-days: 7
          if-no-files-found: warn

      - name: Skip notice
        if: steps.check-creds.outputs.has_creds != 'true'
        run: |
          echo "::notice::Skipping Apple ID signing - no credentials configured"
          echo "To enable: Add APPLE_ID and APPLE_ID_PASSWORD to repository secrets"

  # Alternative: Sign using zsign (ad-hoc, for jailbroken devices)
  sign-adhoc:
    needs: build-unsigned
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Download unsigned IPA
        uses: actions/download-artifact@v4
        with:
          name: unsigned-ipa
          path: ./

      - name: Install zsign
        run: |
          wget -q https://github.com/zhlynn/zsign/releases/latest/download/zsign-linux-x64 -O zsign || \
          wget -q https://github.com/xtool-org/zsign/releases/latest/download/zsign-linux-x64 -O zsign
          chmod +x zsign
          ./zsign -v || echo "zsign ready"

      - name: Ad-hoc sign IPA
        run: |
          IPA_FILE="${{ needs.build-unsigned.outputs.ipa_name }}"
          ADHOC_IPA="${{ env.APP_NAME }}-adhoc.ipa"
          BUNDLE_ID="${{ github.event.inputs.bundle_id || env.DEFAULT_BUNDLE_ID }}"
          BUNDLE_NAME="${{ github.event.inputs.bundle_name || env.APP_NAME }}"
          
          echo "Creating ad-hoc signed IPA..."
          
          ./zsign -a \
            -b "$BUNDLE_ID" \
            -n "$BUNDLE_NAME" \
            -o "$ADHOC_IPA" \
            "$IPA_FILE"
          
          echo "Created: $ADHOC_IPA"
          ls -la "$ADHOC_IPA"

      - name: Upload ad-hoc IPA
        uses: actions/upload-artifact@v4
        with:
          name: adhoc-ipa-${{ github.sha }}
          path: ${{ env.APP_NAME }}-adhoc.ipa
          retention-days: 30

  # Summary
  summary:
    needs: [build-unsigned, sign-with-apple-id, sign-adhoc]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Build Summary
        run: |
          echo "## iOS Sideload Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unsigned IPA | ${{ needs.build-unsigned.result }} | Raw build, needs signing |" >> $GITHUB_STEP_SUMMARY
          echo "| Apple ID Signed | ${{ needs.sign-with-apple-id.result }} | Signed with free Apple ID (7-day expiry) |" >> $GITHUB_STEP_SUMMARY
          echo "| Ad-hoc Signed | ${{ needs.sign-adhoc.result }} | For jailbroken devices or TrollStore |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### How to Install" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Option 1: Apple ID Signed IPA**" >> $GITHUB_STEP_SUMMARY
          echo "- Download the signed IPA artifact" >> $GITHUB_STEP_SUMMARY
          echo "- Install using AltStore, Sideloadly, or similar tool" >> $GITHUB_STEP_SUMMARY
          echo "- App expires after 7 days, needs re-signing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Option 2: Ad-hoc IPA (TrollStore/Jailbreak)**" >> $GITHUB_STEP_SUMMARY
          echo "- Download the ad-hoc IPA artifact" >> $GITHUB_STEP_SUMMARY
          echo "- Install using TrollStore (iOS 14.0-17.0)" >> $GITHUB_STEP_SUMMARY
          echo "- Or install on jailbroken device via Filza" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Option 3: Sign Locally**" >> $GITHUB_STEP_SUMMARY
          echo "- Download the unsigned IPA artifact" >> $GITHUB_STEP_SUMMARY
          echo "- Sign using Sideloadly with your Apple ID" >> $GITHUB_STEP_SUMMARY
          echo "- This is the most reliable method" >> $GITHUB_STEP_SUMMARY
